name: Release Build

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: false
        default: ''

jobs:
  # Validate release
  validate:
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
      release_version: ${{ steps.version.outputs.release_version }}
      is_tag: ${{ steps.version.outputs.is_tag }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" =~ ^refs/tags/ ]]; then
            # Tag event
            release_version=${GITHUB_REF##refs/tags/}
            app_version=${release_version#v}
            is_tag=true
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            # Manual workflow with version
            app_version="${{ github.event.inputs.version }}"
            release_version="v$app_version"
            is_tag=false
          else
            # Manual workflow without version
            app_version="0.0.1-dev-$(date +%Y%m%d-%H%M%S)"
            release_version="v$app_version"
            is_tag=false
          fi
          
          echo "app_version=$app_version" >> $GITHUB_OUTPUT
          echo "release_version=$release_version" >> $GITHUB_OUTPUT
          echo "is_tag=$is_tag" >> $GITHUB_OUTPUT
          
          echo "ðŸ·ï¸ Release Version: $release_version"
          echo "ðŸ“± App Version: $app_version"
          echo "ðŸ”– Is Tag: $is_tag"

  # Run tests
  test:
    needs: validate
    uses: ./.github/workflows/test.yml
    secrets: inherit

  # Build frontend once for all build jobs and cache it
  build-frontend:
    needs: [validate, test]
    uses: ./.github/workflows/build-frontend.yml
    secrets: inherit

  # Build portable executables
  build-executables:
    needs: [validate, test, build-frontend]
    uses: ./.github/workflows/build-executable.yml
    secrets: inherit

  # Build Windows installer
  build-windows-installer:
    needs: [validate, test, build-frontend]
    uses: ./.github/workflows/build-windows-installer.yml
    secrets: inherit

  # Build macOS installers (Intel and ARM)
  build-macos:
    needs: [validate, test, build-frontend]
    uses: ./.github/workflows/build-macos-installer.yml
    secrets: inherit

  # Build and push Docker image(s)
  build-docker:
    needs: [validate, test]
    uses: ./.github/workflows/build-docker.yml
    secrets: inherit

  # Create GitHub release
  create-release:
    needs: [validate, build-executables, build-windows-installer, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Get vault secrets
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_HOST }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets:
            secrets/data/github repo_readonly_pat | REPO_READONLY_PAT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts:"
          find ./artifacts -type f -name "*.zip" -o -name "*.pkg" -o -name "*.exe" | sort

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.validate.outputs.release_version }}
          tag_name: ${{ needs.validate.outputs.release_version }}
          token: ${{ env.REPO_READONLY_PAT }}
          make_latest: true
          target_commitish: main
          generate_release_notes: true
          files: |
            ./artifacts/**/*.zip
            ./artifacts/**/*.pkg
            ./artifacts/**/*.exe

  # Summary job
  summary:
    needs: [validate, test, build-executables, build-windows-installer, build-macos, build-docker]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Record workflow start time
        id: workflow-start
        run: |
          # Get workflow start time from GitHub API
          workflow_start=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }} --jq '.run_started_at')
          start_epoch=$(date -d "$workflow_start" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$workflow_start" +%s)
          echo "start=$start_epoch" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          # Calculate total workflow duration
          start_time=${{ steps.workflow-start.outputs.start }}
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          minutes=$((duration / 60))
          seconds=$((duration % 60))
          echo "## ðŸ—ï¸ Cleanuparr Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.validate.outputs.release_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**App Version**: ${{ needs.validate.outputs.app_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Is Tag**: ${{ needs.validate.outputs.is_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Total Duration**: ${minutes}m ${seconds}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check test results
          if [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "âœ… **Tests**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          # Check job results
          if [[ "${{ needs.build-executables.result }}" == "success" ]]; then
            echo "âœ… **Portable Executables**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Portable Executables**: ${{ needs.build-executables.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.build-windows-installer.result }}" == "success" ]]; then
            echo "âœ… **Windows Installer**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Windows Installer**: ${{ needs.build-windows-installer.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.build-macos.result }}" == "success" ]]; then
            echo "âœ… **macOS Installers (Intel & ARM)**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **macOS Installers (Intel & ARM)**: ${{ needs.build-macos.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.build-docker.result }}" == "success" ]]; then
            echo "âœ… **Docker Image Build**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Docker Image Build**: ${{ needs.build-docker.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Build completed!**" >> $GITHUB_STEP_SUMMARY 