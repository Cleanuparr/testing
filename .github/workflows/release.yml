name: Release Build

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: false
        default: ''

jobs:
  # Validate release
  validate:
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
      release_version: ${{ steps.version.outputs.release_version }}
      is_tag: ${{ steps.version.outputs.is_tag }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" =~ ^refs/tags/ ]]; then
            # Tag event
            release_version=${GITHUB_REF##refs/tags/}
            app_version=${release_version#v}
            is_tag=true
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            # Manual workflow with version
            app_version="${{ github.event.inputs.version }}"
            release_version="v$app_version"
            is_tag=false
          else
            # Manual workflow without version
            app_version="0.0.1-dev-$(date +%Y%m%d-%H%M%S)"
            release_version="v$app_version"
            is_tag=false
          fi
          
          echo "app_version=$app_version" >> $GITHUB_OUTPUT
          echo "release_version=$release_version" >> $GITHUB_OUTPUT
          echo "is_tag=$is_tag" >> $GITHUB_OUTPUT
          
          echo "üè∑Ô∏è Release Version: $release_version"
          echo "üì± App Version: $app_version"
          echo "üîñ Is Tag: $is_tag"

  build-frontend:
    needs: [validate]
    uses: ./.github/workflows/build-frontend.yml
    secrets: inherit

  # Build portable executables
  build-executables:
    needs: [validate, build-frontend]
    uses: ./.github/workflows/build-executable.yml
    secrets: inherit
  create-release:
    needs: [validate, build-frontend, build-executables]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Get vault secrets
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_HOST }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets:
            secrets/data/github repo_readonly_pat | REPO_READONLY_PAT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: List downloaded artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find ./artifacts -type f -name "*.zip" -o -name "*.pkg" -o -name "*.exe" | sort

      - name: Get draft release changelog
        id: draft
        run: |
          # Find the first draft release created by release-drafter
          draft_id=$(gh api repos/${{ github.repository }}/releases --jq '[.[] | select(.draft == true)][0].id // empty')

          if [[ -n "$draft_id" ]]; then
            # Get the full release info using the specific release ID
            draft_tag=$(gh api repos/${{ github.repository }}/releases/$draft_id --jq '.tag_name')

            # Get the body and save to file (handles multiline properly)
            gh api repos/${{ github.repository }}/releases/$draft_id --jq '.body' > draft_body.txt

            echo "üìù Found draft release: $draft_tag (ID: $draft_id)"
            echo "üìÑ Changelog preview:"
            head -5 draft_body.txt
            echo "..."
            echo "draft_id=$draft_id" >> $GITHUB_OUTPUT
            echo "has_draft=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No draft release found, will generate release notes"
            echo "has_draft=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete draft release
        if: steps.draft.outputs.has_draft == 'true'
        run: |
          echo "üóëÔ∏è Deleting draft release (ID: ${{ steps.draft.outputs.draft_id }})"
          gh api -X DELETE repos/${{ github.repository }}/releases/${{ steps.draft.outputs.draft_id }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read changelog body
        id: changelog
        run: |
          if [[ -f draft_body.txt ]]; then
            {
              echo "body<<CHANGELOG_EOF"
              cat draft_body.txt
              echo "CHANGELOG_EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "body=" >> $GITHUB_OUTPUT
          fi

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.validate.outputs.release_version }}
          tag_name: ${{ needs.validate.outputs.release_version }}
          body: ${{ steps.changelog.outputs.body }}
          generate_release_notes: ${{ steps.draft.outputs.has_draft != 'true' }}
          token: ${{ env.REPO_READONLY_PAT }}
          make_latest: true
          target_commitish: main
          files: |
            ./artifacts/**/*.zip
            ./artifacts/**/*.pkg
            ./artifacts/**/*.exe

  # Summary job
  summary:
    needs: [validate, build-executables]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Record workflow start time
        id: workflow-start
        run: |
          # Get workflow start time from GitHub API
          workflow_start=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }} --jq '.run_started_at')
          start_epoch=$(date -d "$workflow_start" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$workflow_start" +%s)
          echo "start=$start_epoch" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          # Calculate total workflow duration
          start_time=${{ steps.workflow-start.outputs.start }}
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          minutes=$((duration / 60))
          seconds=$((duration % 60))
          echo "## üèóÔ∏è Cleanuparr Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.validate.outputs.release_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**App Version**: ${{ needs.validate.outputs.app_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Is Tag**: ${{ needs.validate.outputs.is_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Total Duration**: ${minutes}m ${seconds}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check test results
          if [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "‚úÖ **Tests**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          # Check job results
          if [[ "${{ needs.build-executables.result }}" == "success" ]]; then
            echo "‚úÖ **Portable Executables**: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Portable Executables**: ${{ needs.build-executables.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ **Build completed!**" >> $GITHUB_STEP_SUMMARY 